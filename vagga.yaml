commands:

  make:
    description: Build lithos in ubuntu container
    container: ubuntu
    command: [make]

  build-ubuntu-package:
    description: Build ubuntu (trusty) package
    container: ubuntu
    write-mode: transient-hard-link-copy
    command:
    - checkinstall
    - --default
    - --maintainer=paul@colomiets.name
    - --pkglicense=MIT
    - --pkgname=lithos
    - --nodoc
    - --strip=no
    - make
    - -B
    - all
    - install

  docs:
    description: Build HTML docs
    container: docs
    work-dir: docs
    command: [make, html]

  make-docs:
    description: Build
    container: ubuntu
    work-dir: docs
    command: [make]


containers:

  busybox:
    # This one is used as a container inside the lithos example
    builder: docker
    parameters:
      image: busybox
    provision: |
      set -ex
      export PATH=/bin
      mkdir /config
      cat <<END > /config/sleep.yaml
      kind: Daemon
      user_id: 1
      volumes:
        /tmp: tmpfs:size=100m
      memory_limit: 104857600
      cpu_shares: 3
      executable: /bin/sleep
      arguments: [60]
      uid-map:
      - {inside: 0, outside: 1000, count: 1}
      - {inside: 1, outside: 1, count: 1}
      gid-map:
      - {inside: 0, outside: 100, count: 1}
      END
      cat <<END > /config/busybox.yaml
      kind: Command
      user_id: 1
      volumes:
        /tmp: tmpfs:size=100m
      memory_limit: 104857600
      cpu_shares: 3
      executable: /bin/busybox
      uid-map:
      - {inside: 0, outside: 1000, count: 1}
      - {inside: 1, outside: 1, count: 1}
      gid-map:
      - {inside: 0, outside: 100, count: 1}
      END

  ubuntu:
    # The container to build lithos ubuntu package
    builder: ubuntu
    uids: [0-1000, 65534]
    gids: [0-1000, 65534]
    parameters:
      repos: universe
      packages: make checkinstall wget
    provision: |
      export PATH=/bin:/usr/bin:/usr/bin/local
      chown root /var/spool/rsyslog
      cd /work/run
      wget https://static.rust-lang.org/dist/rust-1.0.0-alpha-x86_64-unknown-linux-gnu.tar.gz
      tar -xf rust-1.0.0-alpha-x86_64-unknown-linux-gnu.tar.gz
      cd rust-1.0.0-alpha-x86_64-unknown-linux-gnu
      ./install.sh --prefix=/usr
    environ:
      LD_LIBRARY_PATH: /usr/lib/rustlib/x86_64-unknown-linux-gnu/lib
    tmpfs-volumes:
      /tmp: size=1m,mode=1777
      /var/tmp: size=100m,mode=1777

  docs:
    builder: alpine
    parameters:
      packages: py-sphinx make
